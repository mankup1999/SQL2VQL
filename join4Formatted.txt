create table oed_master_table nologging as select ord_actn_strt _date_key, cust_ctct_idnt_doc_1_no, 'tv' as product from ( selec t distinct ord_tran.ord_actn_id as ord_actn_id , ord_tran.ord_actn_strt_ts as ord_actn_strt_ts , ord_tran.ord_actn_strt_date_key, ord_t ran.main_cmpn_nm, ord_tran.assg_prod_id as assg_prod_id , ord_tran.main_cmpn_id, ord_tran.assg_prce_plan_id as assg_prce_plan_id, ord_tran.serv_type_cd as serv_type_cd, ord_tran.ord_actn_done_ts as ord_actn_done_ts , ord_tran.ord_actn_done_date_key, ord_tra n.deal_id, ord_tran.deal_nm, empl.empl_or_ssmn_cd, subs.prim_rsrc_valu_txt as prim_rsrc_ valu_txt , subs.subs_id as subs_i d , oa_stts.ord_actn_stts_ds as ord_actn_stt s_ds , oa_type.ord_actn_type_ds as ord_actn_t ype_ds , oa_rsn.ord_actn_rsn_ds as ord_actn _rsn_ds , ctct.idnt_doc_1_no as cust_c tct_idnt_doc_1_no , ctct.frst_nm, cust.cust_id, assg_bill_offr.bill_offr_ds bil l_offr_ds, assg_bill_offr.base_plan_ind, assg_cmpn_offr.prod_ds cmpn_prod_ds, a ssg_prod_stat.assg_prod_stat_id/*, chnl_nm.sale_ serv_chnl_nm*/ from ep_rel.ord_tran, (select subs_key,su bs_id,prim_rsrc_valu_txt,open_ts,clse_ts from ep _rel.subs where ecf_delt_flg = 0 ) subs, (sele ct ord_actn_stts_key,ord_actn_stts_ds,open_ts,clse_ts from ep_rel.ord_actn_stts where ecf_delt_flg = 0 ) oa_stts, (select ord_actn_type_key,ord_actn_type_ds,ord_actn_ type_id,open_ts,clse_ts from ep_rel.ord_actn_type where ecf_de lt_flg = 0 ) oa_type, (select ord_actn_rsn_key,ord_actn_r sn_ds,ord_actn_rsn_id,open_ts,clse_ts from ep_rel.ord_actn_rsn where ecf_delt_flg = 0 ) oa_rsn, (select ctct_key,id nt_doc_1_no,open_ts,clse_ts,frst_nm from ep _rel.ctct where ecf_delt_flg = 0 ) ctct, (sele ct cust_key,cust_id,open_ts,clse_ts from ep_rel.cust where ecf_delt_flg = 0 ) cust, (select base_plan_ind,open_ts,clse_ts,bill_offr_key,bil l_offr_ds from ep_rel.bill_offr where ecf_delt_flg = 0 ) assg_bill_offr, (select prod_ctlg_item_id,prod_ ctlg_key, prod_ds,open_ts,clse_ts from ep_rel.prod_ctlg where ecf_delt_flg = 0 ) assg_cmpn_offr, (select assg_prod_stat_id,open_ts,clse_ts,assg_prod_stat_key from ep_rel.assg_prod_stat where ecf_delt_flg = 0 ) assg_prod_stat, /*(select sale_serv_chnl_key, sale_serv_chnl_nm , open_ts, clse_ts from ep_rel.sale_serv_chnl where ecf_delt_flg = 0 ) chnl_nm,*/ (select empl_or_ssmn_cd,op en_ts,clse_ts,empl_key from ep_rel.empl where ecf_delt_flg = 0) empl where ord_tran.subs_key = subs.subs_key (+) and ord_tran.bill_offr_key = assg_bill_offr.bill_offr_key (+) and ord_tran.prod_ctlg _key = assg_cmpn_offr.prod_ctlg_key (+) and ord_tran. ord_actn_stts_key = oa_stts.ord_actn_stts_key (+) and ord _tran.ord_actn_type_key = oa_type.ord_actn_type_key (+) a nd ord_tran.ord_actn_rsn_key = oa_rsn.ord_actn_rsn_key (+) and ord_tran.main_ctct_key = ctct.ctct_key(+) and ord_tran.cust_key = cust.cust_key(+) and ord_tra n.assg_prod_stat_key = assg_prod_stat.assg_prod_stat_key(+) /*and ord_tran.init_sale_serv_chnl_key = chnl_nm.sale_serv_chn l_key(+)*/ and ord_tran.open_ts >= subs.open_ts (+) and ord_tran.open_ts < subs.clse_ts (+) and ord_tran.open_ts >= oa_stts.open_ts (+) and ord_tran.open_ts < oa_stts.clse_ts (+) and ord _tran.open_ts >= oa_type.open_ts (+) and ord_tr an.open_ts < oa_type.clse_ts (+) and ord_tran.o pen_ts >= oa_rsn.open_ts (+) and ord_tran.open_ ts < oa_rsn.clse_ts (+) and ord_tran.open_ts >= ctct.open_ts (+) and ord_tran.open_ts < ctct.clse_ts (+) and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust .clse_ts (+) and ord_tran.open_ts >= assg_bill_ offr.open_ts (+) and ord_tran.open_ts < assg_bi ll_offr.clse_ts (+) and ord_tran.open_ts >= ass g_cmpn_offr.open_ts (+) and ord_tran.open_ts < assg_cmpn_offr.clse_ts (+) and ord_tran.open_ts >= assg_prod_stat.open_ts (+) and ord_tran.open_ts < assg_prod_stat.clse_ts (+) /*and ord_tran.open_ts >= chnl_nm.open_ts (+)*/ /* and ord_tran.open_ts < chnl_nm.clse_ts (+)*/ and ord_tran.crte_empl_key = empl.empl_key(+) and ord_tran.open_ts >= empl.open_ts (+) and ord_tran.open_ts < empl.clse_ts (+) and upper(ord_tran.m ain_cmpn_nm) in ('tv main','cross carriage main') and upper(oa _type.ord_actn_type_ds) in ( 'provide' ) and ord_tran.ecf_delt _flg = 0 and upper(ctct.frst_nm) not like 'brt%' --and ord_t ran.ord_actn_strt_date_key between to_char(trunc(sysdate-7, 'iw' ),'yyyymmdd') and to_char(next_day(trunc(sysdate-7,'iw'),'sunday '),'yyyymmdd') and ord_tran.ord_actn_strt_date_key between 201 90101 and (select end_date from broadband_oed) --and assg_cmpn _offr.prod_ctlg_item_id in ('8635012' ,'8900892' ,'8704672' ,'86 33012' ,'8632982') ) union all select ord_actn_strt_date_key, cust_ctct_idnt_doc_1_no, 'broadband' as product from ( select di stinct ord_tran.ord_actn_id as ord_actn_id , ord_tran.ord_id as order_id, ord _tran.deal_id, ord_tran.deal_nm, ord_tran.vndr_id, ord_tran.vndr_nm, subs.accs_lkge_id, ord_tran.cust_rqst_ts, subs.bb_user_nm, empl.empl_or_ssm n_cd, ord_tran.ord_actn_strt_ts as ord_actn_st rt_ts , ord_tran.ord_actn_strt_date_key, ord_tran.main_cmpn_nm, assg_cmpn_offr.p rod_ds cmpn_prod_ds, assg_bill_offr.bill_offr_ds bill_offr_ds, assg_bill_offr.base_plan_ind, cust.cust_id, ctct.idnt_doc_1_no as cust_ctct_idnt_doc_1_no , ctct.frst_nm , subs.prim_rsrc_valu_txt as prim_rsrc_valu_ txt , ord_tran.serv_type_cd as serv_type_c d, ord_tran.ord_actn_done_ts as ord_actn_done_ ts , ord_tran.ord_actn_done_date_key, ord_tran.ord_tran_year_mnth_no, subs.subs_ id as subs_id , oa_stts.ord_actn_ stts_ds as ord_actn_stts_ds , assg_prod_stat. assg_prod_stat_id, oa_type.ord_actn_type_ds a s ord_actn_type_ds , oa_rsn.ord_actn_rsn_ds as ord_actn_rsn_ds , ord_tran.assg_prod_id as assg_prod_id , ord_tran.main_cmpn_id, ord_tran.assg_prce_plan_id as assg_prce_plan_id, prod_offr.prod_ds as main_prod_offr_ds, assg_bill_offr.bill_offr_id/*, to populate config table chnl_nm.sale_serv_chnl_nm*/ from ep_rel.o rd_tran, (select subs_key,bb_user_nm,accs_lkge_id,subs_id,prim_r src_valu_txt,open_ts,clse_ts,main_prod_offr_ds from ep_rel.subs where ecf_delt_flg = 0 ) subs, (select ord_actn_stt s_key,ord_actn_stts_ds,open_ts,clse_ts from ep_rel.ord_actn_stts where ecf_delt_flg = 0 ) oa_stts, (select ord_actn_type_key,ord_actn_type_ds,ord _actn_type_id,open_ts,clse_ts from ep_ rel.ord_actn_type where ecf_delt_flg = 0 ) oa_type, (select ord_actn_rsn_key,ord_actn_rsn_ds,ord_actn_rsn_id,open_ts,clse_ts from ep_rel.ord_actn_rsn where ecf_delt_flg = 0 ) oa_rsn, (select ctct_key,idnt_doc_1_no,open _ts,clse_ts,frst_nm from ep_rel.ctct where ecf_delt_flg = 0 ) ctct, ( select cust_key,cust_id,open_ts,clse_ts from ep_rel.cust where ecf_delt_flg = 0 ) cust, (select base_plan_ind,open_ts,c lse_ts,bill_offr_key,bill_offr_ds,bill_offr_id from ep_rel.bill_offr where ecf_delt_flg = 0 ) ass g_bill_offr, (select prod_ctlg_item_id,prod_ctlg_key, prod_ds,op en_ts,clse_ts from ep_rel.p rod_ctlg where ecf_delt_flg = 0 ) assg_cmpn_offr, (select empl_or_ssmn_cd,open_ts,clse_ts,empl_key from ep_rel.empl where ecf_delt_flg = 0) empl, (select assg_prod_stat_id,open_ts,clse_ts,assg_prod_stat_key from ep_rel.assg_prod_stat where ecf_delt_flg = 0 ) assg_prod_st at, (select prod_ds , prod_ctlg_key from ep_rel.prod_ctlg where ecf_delt_flg=0 and ecf_xpir_ts='31-dec-9999') prod_of fr/*, (select sale_serv_chnl_key, sale_serv_chnl_nm, open_ts, cl se_ts from ep_rel.sale_ser v_chnl where ecf_delt_flg = 0 ) chnl_nm*/ where ord_tran.sub s_key = subs.subs_key (+) and ord_tran.bill_off r_key = assg_bill_offr.bill_offr_key (+) and ord_tran.pro d_ctlg_key = assg_cmpn_offr.prod_ctlg_key (+) and ord_tra n.ord_actn_stts_key = oa_stts.ord_actn_stts_key (+) and ord_t ran.ord_actn_type_key = oa_type.ord_actn_type_key (+) and ord _tran.ord_actn_rsn_key = oa_rsn.ord_actn_rsn_key (+) and ord _tran.main_ctct_key = ctct.ctct_key(+) and ord_tran.cust_ key = cust.cust_key(+) and ord_tran.assg_prod_stat_key = assg_prod_stat.assg_prod_stat_key(+) and ord_tran.crte_em pl_key = empl.empl_key(+) and ord_tran.main_prod_offr_key =prod_offr.prod_ctlg_key (+) and ord_tran.open_ts >= subs.open_ts (+) and ord_tran.open_ts < subs.cls e_ts (+) and ord_tran.open_ts >= oa_stts.open_ts (+ ) and ord_tran.open_ts < oa_stts.clse_ts (+) and ord_tran.open_ts >= oa_type.open_ts (+) and ord_tra n.open_ts < oa_type.clse_ts (+) and ord_tran.open_t s >= oa_rsn.open_ts (+) and ord_tran.open_ts < oa_rsn.clse_ts (+) and ord_tran.open_ts >= c tct.open_ts (+) and ord_tran.open_ts < ctct.clse_ts (+) and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust.clse_ts (+) and ord_tran.o pen_ts >= assg_bill_offr.open_ts (+) and ord_tran.o pen_ts < assg_bill_offr.clse_ts (+) and ord_tran.op en_ts >= assg_cmpn_offr.open_ts (+) and ord_tran.op en_ts < assg_cmpn_offr.clse_ts (+) and ord_tran.ope n_ts >= assg_prod_stat.open_ts (+) and ord_tran.ope n_ts < assg_prod_stat.clse_ts (+) and ord_tran.open _ts >= empl.open_ts (+) and ord_tran.open_ts < empl.clse_ts (+) /*and ord_tran.open_ts >= c hnl_nm.open_ts (+) and ord_tran.open_ts < chnl_nm.c lse_ts (+)*/ /*and ord_tran.ord_actn_strt_date_key between 201 80201 and 20180227 */ and upper(ord_tran.main_cmpn_nm) in ('br oadband main') and upper(oa_type.ord_actn_type_ds) in ( 'provi de' ) and ord_tran.main_ctct_key <> -1 and upper(ctct.frst_n m) not like 'brt%' and ord_tran.ecf_delt_flg = 0 and assg_cm pn_offr.prod_ctlg_item_id = '8623942' and assg_prce_plan_id <> -1 --and ord_actn_strt_date_key between to_char(trunc(sysdate -7, 'iw'),'yyyymmdd') and to_char(next_day(trunc(sysdate-7,'iw') ,'sunday'),'yyyymmdd') --- for tv oed; and ord_tran.ord_actn_ strt_date_key between 20190101 and (select end_date from broadba nd_oed) and upper(oa_stts.ord_actn_stts_ds) in (/*'negotiation ',*/'delivery', 'done'/*,'cancelled'*/,'completion') and upper (assg_cmpn_offr.prod_ds) = 'broadband plan' and assg_bill_offr .bill_offr_ds is not null and assg_bill_offr.base_plan_ind = 'y' and ctct.idnt_doc_1_no is not null and cust.cust_id is n ot null and assg_prod_stat.assg_prod_stat_id is not null ) union all select ord_actn_strt_date_key, cust_ctct_idnt_doc_1_n o, 'broadband' as product from ( select distinct ord_tran.ord_ actn_id as ord_actn_id , ord_tran.ord_id as order_id, ord_tran.deal_id, ord_tran.deal_nm, ord_tran.vndr_id, ord_tran.vndr_nm, ord_tran.cust_r qst_ts, subs.bb_user_nm, subs.ac cs_lkge_id, empl.empl_or_ssmn_cd, ord_tran.ord_actn_strt_ts as ord_actn_strt_ts , ord_tran.ord_actn_strt_date_key, ord_tran.ma in_cmpn_nm, assg_cmpn_offr.prod_ds cmpn_prod_ds, assg_bill_offr.bill_offr_ds bill_offr_ds, assg_bill_offr.base_plan_ind, cust.cu st_id, ctct.idnt_doc_1_no as cust_ctct_ idnt_doc_1_no , ctct.frst_nm, su bs.prim_rsrc_valu_txt as prim_rsrc_valu_txt , ord_tran.serv_type_cd as serv_type_cd, o rd_tran.ord_actn_done_ts as ord_actn_done_ts , ord_tran.ord_actn_done_date_key, ord_tran.ord_t ran_year_mnth_no, subs.subs_id as subs_id , oa_stts.ord_actn_stts_ds as ord_ac tn_stts_ds , assg_prod_stat.assg_prod_stat_id, oa_type.ord_actn_type_ds as ord_actn_type_ds , oa_rsn.ord_actn_rsn_ds as ord_actn_rsn_ds , ord_tran.assg_prod_id as assg_prod_id , ord_tran.main_cmpn_id, ord_tran. assg_prce_plan_id as assg_prce_plan_id, prod_of fr.prod_ds as main_prod_offr_ds, ap_cl ss.serv_tech_nm as main_prod_offr_clss_ds, ap_prev_clss.serv_tech_nm as prev_main_prod_offr_clss_ds, assg_bill_offr.bill_offr_id/*, to populat e config table chnl_nm.sale_serv_chnl_nm*/ from ep_rel.ord_tran, (select subs_key,accs_lkge_id,subs_id,bb_user_ nm,prim_rsrc_valu_txt,open_ts,clse_ts,main_prod_offr_clss_ds,pre v_main_prod_offr_clss_ds,main_prod_offr_ds,prev_main_prod_offr_d s from ep_rel.subs where ecf_delt_flg = 0 ) subs, (select ord _actn_stts_key,ord_actn_stts_ds,open_ts,clse_ts from ep_rel.ord_ actn_stts where ecf_delt_flg = 0 ) oa_stts, (select ord_actn _type_key,ord_actn_type_ds,ord_actn_type_id,open_ts,clse_ts from ep_rel.ord_actn_type where ecf_delt_flg = 0 ) oa_type, (sel ect ord_actn_rsn_key,ord_actn_rsn_ds,ord_actn_rsn_id,open_ts,cls e_ts from ep_rel.ord_actn_rsn where ecf_delt_flg = 0 ) oa_rs n, (select ctct_key,idnt_doc_1_no,open_ts,clse_ts,frst_nm from e p_rel.ctct where ecf_delt_flg = 0 ) ctct, (select cust_key,cust_id,open_ts,clse_ts from ep_rel.cust where ecf_delt_flg = 0 ) cust, (select base_plan_ind,open_ts,clse_ts,bill_offr_key,bill_ offr_ds,bill_offr_id from ep_rel.bill_offr where ecf_delt_flg = 0 ) assg_bill_offr, (select prod_ctlg_item_id,prod_ctlg_key, prod_ds,open_ts,clse_ts from ep_rel.prod_ctlg where ecf_delt_fl g = 0 ) assg_cmpn_offr, (select empl_or_ssmn_cd,open_ts,clse_ts ,empl_key from ep_rel.empl where ecf_delt_flg = 0) empl, (selec t assg_prod_stat_id,open_ts,clse_ts,assg_prod_stat_key from ep_r el.assg_prod_stat where ecf_delt_flg = 0 ) assg_prod_stat, (se lect prod_ds , prod_ctlg_key from ep_rel.prod_ctlg where ecf_del t_flg=0 and ecf_xpir_ts='31-dec-9999') prod_offr, (select assg_p rod_id,serv_tech_nm from ( select assg_prod_id,serv_tech_nm, ran k() over ( partition by assg_prod_id order by strt_ts desc,end_t s desc,assg_prod_vrsn_id desc) as rank from ep_rel.assg_prod ap where ap.ecf_xpir_ts='31-dec-9999' and ap.main_cmpn_flg=1 and ap .serv_tech_nm is not null ) where rank=1 ) ap_clss, (select assg _prod_id,serv_tech_nm from ( select assg_prod_id,serv_tech_nm,ra nk() over ( partition by assg_prod_id order by strt_ts desc,end_ ts desc,assg_prod_vrsn_id desc) as rank from ep_rel.assg_prod ap where ap.ecf_xpir_ts='31-dec-9999' and ap.main_cmpn_flg=1 and a p.serv_tech_nm is not null ) where rank=2) ap_prev_clss /*, (sel ect sale_serv_chnl_key, sale_serv_chnl_nm, open_ts, clse_ts from ep_rel.sale_serv_chnl where ecf_delt_flg = 0 ) chnl_nm*/ where ord_tran.subs_key = subs.subs_key ( +) and ord_tran.bill_offr_key = assg_bill_offr.bill_offr_ key (+) and ord_tran.prod_ctlg_key = assg_cmpn_offr.prod_ ctlg_key (+) and ord_tran.ord_actn_stts_key = oa_stts.ord_act n_stts_key (+) and ord_tran.ord_actn_type_key = oa_type.ord_a ctn_type_key (+) and ord_tran.ord_actn_rsn_key = oa_rsn.ord_ actn_rsn_key (+) and ord_tran.main_ctct_key = ctct.ctct_k ey(+) and ord_tran.cust_key = cust.cust_key(+) and ord_tran.assg_prod_stat_key = assg_prod_stat.assg_prod_stat_key (+) and ord_tran.crte_empl_key = empl.empl_key(+) and o rd_tran.main_prod_offr_key = prod_offr.prod_ctlg_key and ord_t ran.main_cmpn_id = ap_clss.assg_prod_id (+) and ord_tran .main_cmpn_id = ap_prev_clss.assg_prod_id (+) and ord_tr an.open_ts >= subs.open_ts (+) and ord_tran.open_ts < subs.clse_ts (+) and ord_tran.open_ts >= oa_stts.open_ts (+) and ord_tran.open_ts < oa_s tts.clse_ts (+) and ord_tran.open_ts >= oa_type.ope n_ts (+) and ord_tran.open_ts < oa_type.clse_ts (+) and ord_tran.open_ts >= oa_rsn.open_ts (+) and o rd_tran.open_ts < oa_rsn.clse_ts (+) and ord_tran.o pen_ts >= ctct.open_ts (+) and ord_tran.open_ts < ctct.clse_ts (+) and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust.clse_t s (+) and ord_tran.open_ts >= assg_bill_offr.open_t s (+) and ord_tran.open_ts < assg_bill_offr.clse_ts (+) and ord_tran.open_ts >= assg_cmpn_offr.open_ts (+) and ord_tran.open_ts < assg_cmpn_offr.clse_ts (+) and ord_tran.open_ts >= assg_prod_stat.open_ts (+) and ord_tran.open_ts < assg_prod_stat.clse_ts ( +) and ord_tran.open_ts >= empl.open_ts (+) and o rd_tran.open_ts < empl.clse_ts (+) /*and ord_tran.o pen_ts >= chnl_nm.open_ts (+) and ord_tran.open_ts < chnl_nm.clse_ts (+)*/ /*and ord_tran.ord_actn_st rt_date_key between 20180201 and 20180227*/ and upper(ord_tran .main_cmpn_nm) in ('broadband main') and upper(oa_type.ord_act n_type_ds) in ( 'change' ) and upper(ord_actn_rsn_ds) in ('rec ontracting','change plan') and ord_tran.main_ctct_key <> -1 and upper(ctct.frst_nm) not like 'brt%' and ord_tran.ecf_delt_ flg = 0 and assg_cmpn_offr.prod_ctlg_item_id = '8623942' and assg_prce_plan_id <> -1 and assg_prc_plan_stts_key <> 3 --a nd ord_actn_strt_date_key between to_char(trunc(sysdate-7, 'iw') ,'yyyymmdd') and to_char(next_day(trunc(sysdate-7,'iw'),'sunday' ),'yyyymmdd') --- for tv oed; and ord_tran.ord_actn_strt_date _key between 20190101 and (select end_date from broadband_oed) and upper(oa_stts.ord_actn_stts_ds) in (/*'negotiation',*/'deli very', 'done'/*,'cancelled'*/,'completion') and upper(assg_cmp n_offr.prod_ds) = 'broadband plan' and assg_bill_offr.bill_off r_ds is not null and assg_bill_offr.base_plan_ind = 'y' and ctct.idnt_doc_1_no is not null and cust.cust_id is not null and assg_prod_stat.assg_prod_stat_id is not null ) union al l select ord_actn_strt_date_key, idnt_doc_1_no, 'mobile' as pro duct from ( select row_number() over (partition b y oa.ord_actn_strt_date_key, s.subs_id order by oa.ord_actn_id) as row_num , oa.ord_actn_strt_date_key , c ase when oat.ord_actn_type_ds in ('provide','reestablish') or oa r.ord_actn_rsn_ds = 'pre to post' then 'gross add' when oat.ord_actn_type_ds in ('cease', 'collection cease') then 'churn' -- 'cease' = vol ec + 'collection cease' = invol ec when (oat.ord_actn_type_ds in ('change','chan ge ownership') and upper(ord_actn_rsn_ds) in ('recontracting') ) then 'recon' -- sim only is captured end as d river_ind , case when (oat.ord_actn_type_ds in ('prov ide','reestablish')) and s.port_type_cd = 'i' and upper(s.port_o per_nm) like 'starhub' then 'port in - starhub' when (oat.ord_actn_type_ds in ('provide','reestablish')) and s .port_type_cd = 'i' and upper(s.port_oper_nm) like 'm1' then 'po rt in - m1' when (oat.ord_actn_type_ds in ('ce ase')) and s.port_type_cd = 'e' and upper(s.port_oper_nm) like ' starhub' then 'port out - starhub' when (oat.o rd_actn_type_ds in ('cease')) and s.port_type_cd = 'e' and upper (s.port_oper_nm) like 'm1' then 'port out - m1' end as port_ind , to_char(oa.ord_actn_id) as ord_ac tn_id , s.prim_rsrc_valu_txt as svc_no , s .subs_id , bo.bill_offr_ds as price_plan , z.price_plan_gp , z.plan_ind , z.price_pl an_ctg , eq.equp_modl_nm as handset_model , oa.deal_id as dealer_cd , em.empl_or_ssmn_cd as sal esman_cd , c.idnt_doc_1_no from (select * from ep_rel.ord_actn oa where trunc(oa.ecf_x pir_ts) = '31-dec-9999' and oa.ecf_delt_flg = 0 --and oa.ord_actn_strt_date_key between to_number(to_c har(trunc(sysdate-21,'iw'),'yyyymmdd')) and to_number(to_char((s ysdate-1),'yyyymmdd')) and oa.main_flg = 1 and oa.ord_stts_key <> 1 -- cancelled and oa.p rnt_rel_type_cd <> 'ca' ) oa left join ep_rel .ord_actn_rsn oar on oa.ord_actn_rsn_key = oar.ord _actn_rsn_key and trunc(oar.ecf_xpir_ts) = '31-dec- 9999' and oar.ecf_delt_flg = 0 left join ep_ rel.ord_actn_type oat on oa.ord_actn_type_key = oa t.ord_actn_type_key and trunc(oat.ecf_xpir_ts) = '3 1-dec-9999' and oat.ecf_delt_flg = 0 left jo in ep_rel.ord_actn_stts oas on oa.ord_actn_stts_ke y = oas.ord_actn_stts_key and trunc(oas.ecf_xpir_ts ) = '31-dec-9999' and oas.ecf_delt_flg = 0 le ft join ep_rel.subs s on oa.subs_key = s.subs_key and trunc(s.ecf_xpir_ts) = '31-dec-9999' and s.ecf_delt_flg = 0 left join ep_rel.bill_offr bo on s.main_bill_offr_key = bo.bill_offr_key and trunc(bo.ecf_xpir_ts) = '31-dec-9999' and bo.ecf_delt_flg = 0 left join ep_rel.line_of_bsns slob on s.subs_line_of_bsns_id = slob.line_of_bsns_id and trunc(slob.ecf_xpir_ts) = '31-dec-9999' and slob.ecf_delt_flg = 0 left join ep_rel.prod_line_ of_bsns plob on s.prod_line_of_bsns_key = plob.pro d_line_of_bsns_key and trunc(plob.ecf_xpir_ts) = '3 1-dec-9999' and plob.ecf_delt_flg = 0 left j oin ep_rel.cust_ctct_rel ccr on s.cust_key = ccr.c ust_key and trunc(ccr.ecf_xpir_ts) = '31-dec-9999' and ccr.ecf_delt_flg = 0 and ccr.role_ name_type = 'primary' and ccr.actv_ind = 1 le ft join ep_rel.ctct c on ccr.ctct_key = c.ctct_ke y and trunc(c.ecf_xpir_ts) = '31-dec-9999' and c.ecf_delt_flg = 0 left join ep_rel.cust_type ct on oa.cust_type_key = ct.cust_type_key and trunc(ct.ecf_xpir_ts) = '31-dec-9999' and ct .ecf_delt_flg = 0 left join ep_rel.ord_tran ot on trunc(ot.ecf_xpir_ts) = '31-dec-9999' and ot .ecf_delt_flg = 0 and ot.main_cmpn_nm = 'mobile mai n' and ot.main_bill_offr_key = ot.bill_offr_key and ot.bill_offr_assg_stts_id <> 'removed' and oa.ord_actn_key = ot.ord_actn_key and oa.ord_ actn_done_date_key = ot.ord_actn_done_date_key left join ep_rel.equp_ctlg eq on trunc(eq.ecf_xpir_ts) = '31 -dec-9999' and eq.ecf_delt_flg = 0 and ot.equp_ctlg_key = eq.equp_ctlg_key left join ep_rel.emp l em on trunc(em.ecf_xpir_ts) = '31-dec-9999' and em.ecf_delt_flg = 0 and ot.crte_empl_k ey = em.empl_key left join biz_ba.cfg_bill_offer z on bo.bill_offr_ds = z.bill_offr_ds where upper(ct .cust_type_ds) = 'consumer' and upper(slob.line_of_bsns_d s) = 'mobile postpaid' and upper(s.main_prod_offr_clss_ds ) in ('mobile') and upper(c.frst_nm) not like 'brt%' and upper(bo.bill_offr_ds) not in ('mobile phone instant card (category e)','mobile phone instant card(data sim)','hotel mobil e extension service plan subscription','hotel mobile solution mo nthly subscription','data price plan (hotel)','gsm sim card rent al','port-out subscription') and ( upper(s.subs_ctgy_id) not in ('cis','cis_idd') or s.subs_ctgy_id is null ) and o a.ord_actn_strt_date_key between 20190101 and (select end_date f rom broadband_oed) );