create table bcc_bb_oed_recon_mig as select distinct ord_tran.o rd_actn_id as ord_actn_id, ord_tran.ord_ id as order_id, ord_tran.deal_id, ord_tran.deal_nm, ord_tran.vndr_id, ord_tran.vndr_nm, ord_tran.cus t_rqst_ts, subs.bb_user_nm, subs.accs_lkge_id, empl.empl_or_ssmn_cd, ord_tran.ord_actn_strt_ts as ord_actn_strt_ts, ord_tran.ord_actn_strt_date_key, ord_tran.main_cmpn_nm, assg_cmpn_offr.prod_ds cmpn_prod_ ds, assg_bill_offr.bill_offr_ds bill_offr_ds, assg_bill_offr.base_plan_ind, cust.cust_id, ctct.idnt_doc_1_no as cust_ct ct_idnt_doc_1_no, ctct.frst_nm, subs.prim_rsrc_valu_txt as prim_rsrc_valu_txt, ord_tran.serv_type_cd as serv_type_cd, ord_tran.ord_actn_done_ts as ord_actn_done_ts, ord_tran.ord_actn_done_date_key, ord_tran.or d_tran_year_mnth_no, subs.subs_id as subs_id, oa_stts.ord_actn_stts_ds as ord _actn_stts_ds, assg_prod_stat.assg_prod_stat_id, oa_type.ord_actn_type_ds as ord_actn_type_d s, oa_rsn.ord_actn_rsn_ds as ord_actn_rsn_ ds, ord_tran.assg_prod_id as assg_prod_id, ord_tran.main_cmpn_id, ord_tr an.assg_prce_plan_id as assg_prce_plan_id, prod _offr.prod_ds as main_prod_offr_ds, ap_cls s.serv_tech_nm as main_prod_offr_clss_ds, ap_ prev_clss.serv_tech_nm as prev_main_prod_offr_clss_ds, assg_bill_offr.bill_offr_id, chnl_nm.sale_serv_chnl_nm from ep_rel.o rd_tran, ( select subs_key, accs_lkge_id, subs_id, bb_user_nm, prim_r src_valu_txt, open_ts, clse_ts, main_prod_offr_clss_ds, prev_main_pr od_offr_clss_ds, main_prod_offr_ds, prev_main_prod_offr_ds from ep _rel.subs where ecf_delt_flg = 0 ) subs, ( select ord_actn_stt s_key, ord_actn_stts_ds, open_ts, clse_ts from ep_rel.ord_actn_stts where ecf_delt_flg = 0 ) oa_stts, ( select ord_actn_type_key, ord_actn_type_ds, ord_actn_type_id, open_ts, clse_ts from ep_rel.o rd_actn_type where ecf_delt_flg = 0 ) oa_type, ( select ord_a ctn_rsn_key, ord_actn_rsn_ds, ord_actn_rsn_id, open_ts, clse_ts from ep_rel.ord_actn_rsn where ecf_delt_flg = 0 ) oa_rsn, ( selec t ctct_key, idnt_doc_1_no, open_ts, clse_ts, frst_nm from ep_rel.ctc t where ecf_delt_flg = 0 ) ctct, ( select cust_key, cust_id, open _ts, clse_ts from ep_rel.cust where ecf_delt_flg = 0 ) cust, ( s elect base_plan_ind, open_ts, clse_ts, bill_offr_key, bill_offr_ds, b ill_offr_id from ep_rel.bill_offr where ecf_delt_flg = 0 ) as sg_bill_offr, ( select prod_ctlg_item_id, prod_ctlg_key, prod_ds, o pen_ts, clse_ts from ep_rel.prod_ctlg where ecf_delt_flg = 0 ) assg_cmpn_offr, ( select empl_or_ssmn_cd, open_ts, clse_ts, empl_key from ep_rel.empl where ecf_delt_flg = 0 ) empl, ( select assg_pr od_stat_id, open_ts, clse_ts, assg_prod_stat_key from ep_rel.assg_p rod_stat where ecf_delt_flg = 0 ) assg_prod_stat, ( select prod _ds, prod_ctlg_key from ep_rel.prod_ctlg where ecf_delt_flg = 0 a nd ecf_xpir_ts = '31-dec-9999' ) prod_offr, ( select assg_prod_id, se rv_tech_nm from ( select assg_prod_id, serv_tech_nm, rank() over ( partition by assg_prod_id order by strt_ts desc, end_ts desc, as sg_prod_vrsn_id desc ) as rank from ep_rel.assg_prod ap where ap.ecf_xpir_ts = '31-dec-9999' and ap.main_cmpn_flg = 1 and ap.serv_tec h_nm is not null ) where rank = 1 ) ap_clss, ( select assg_prod_id, serv_tech_nm from ( select assg_prod_id, serv_tech_nm, rank() over ( partition by assg_prod_id order by strt_ts desc, end_ts desc, a ssg_prod_vrsn_id desc ) as rank from ep_rel.assg_prod ap where ap.ecf_xpir_ts = '31-dec-9999' and ap.main_cmpn_flg = 1 and ap.serv_te ch_nm is not null ) where rank = 2 ) ap_prev_clss, ( select sale_se rv_chnl_key, sale_serv_chnl_nm, open_ts, clse_ts from ep_rel.sale_serv_chnl where ecf_delt_flg = 0 ) chnl_nm where ord_tran.subs_key = subs.subs_key (+) and ord_ tran.bill_offr_key = assg_bill_offr.bill_offr_key (+) and ord_tran.prod_ctlg_key = assg_cmpn_offr.prod_ctlg_key (+) and ord_tran.ord_actn_stts_key = oa_stts.ord_actn_stts_key (+) and ord_tran.ord_actn_type_key = oa_type.ord_actn_type_key (+) and ord_tran.ord_actn_rsn_key = oa_rsn.ord_actn_rsn_key (+) and ord_tran.main_ctct_key = ctct.ctct_key(+) and o rd_tran.cust_key = cust.cust_key(+) and ord_tran.ass g_prod_stat_key = assg_prod_stat.assg_prod_stat_key(+) and ord _tran.crte_empl_key = empl.empl_key(+) and ord_tran.main_ prod_offr_key = prod_offr.prod_ctlg_key and ord_tran.main_cmpn _id = ap_clss.assg_prod_id (+) and ord_tran.main_cmpn_id = ap_prev_clss.assg_prod_id (+) and ord_tran.open_ts >= subs.open_ts (+) and ord_tran.open_ts < subs.clse_ts (+) and ord_tran.open_ts >= oa_stts.o pen_ts (+) and ord_tran.open_ts < oa_stts.clse_ts (+) and ord_tran.open_ts >= oa_type.open_ts (+) an d ord_tran.open_ts < oa_type.clse_ts (+) and ord_tr an.open_ts >= oa_rsn.open_ts (+) and ord_tran.open_ ts < oa_rsn.clse_ts (+) and ord_tran.open_ts >= ctct.open_ts (+) and ord_tran.open_ts < ctc t.clse_ts (+) and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust.clse_ts (+) and o rd_tran.open_ts >= assg_bill_offr.open_ts (+) and o rd_tran.open_ts < assg_bill_offr.clse_ts (+) and or d_tran.open_ts >= assg_cmpn_offr.open_ts (+) and or d_tran.open_ts < assg_cmpn_offr.clse_ts (+) and ord _tran.open_ts >= assg_prod_stat.open_ts (+) and ord _tran.open_ts < assg_prod_stat.clse_ts (+) and ord_ tran.open_ts >= empl.open_ts (+) and ord_tran.open_ ts < empl.clse_ts (+) and ord_tran.open_ts >= chnl_nm.open_ts (+) and ord_tran.open_ts < ch nl_nm.clse_ts (+) and ord_tran.ord_actn_strt_date_key betwe en 20180201 and 20180227 and upper(ord_tran.main_cmpn_nm) in ('broadband main') and upper(oa_type.ord_actn_type_ds) in (' change') and upper(ord_actn_rsn_ds) in ('recontracting', 'chan ge plan') and ord_tran.main_ctct_key <> -1 and upper(ctct.fr st_nm) not like 'brt%' and ord_tran.ecf_delt_flg = 0 and ass g_cmpn_offr.prod_ctlg_item_id = '8623942' and assg_prce_plan_i d <> -1 and assg_prc_plan_stts_key <> 3 and ord_actn_strt_da te_key between to_char(trunc(sysdate -7, 'iw'), 'yyyymmdd') and to _char( next_day(trunc(sysdate -7, 'iw'), 'sunday'), 'yyyymmdd' ) --- for tv oed and ord_tran.ord_actn_strt_date_key between 201 80910 and 20180916; 