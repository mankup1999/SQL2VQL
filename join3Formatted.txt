create table bcc_bb_oed_recon_mig as select distinct ord_tran.o rd_actn_id as ord_actn_id , ord_tran.ord_ id as order_id, ord_tran.deal_id, ord_tran.deal_nm, ord_tran.vndr_id , ord_tran.vndr_nm, subs.accs_lk ge_id, subs.main_bill_offr_rc_amt, ord_tran.cust_rqst_ts, subs.bb_user_nm, empl.empl_or_ssmn_cd, ord_tran.ord_ac tn_strt_ts as ord_actn_strt_ts , ord_tran.ord_ actn_strt_date_key, ord_tran.main_cmpn_nm, assg_cmpn_offr.prod_ds as cmpn_prod_ds, assg_bill_offr.bill_offr_ds as bill_offr_ds, assg_bill_offr.base_plan_ind, cust.cust_id, ctct.idnt_doc_1_no as cust_ctct_idnt_d oc_1_no , ctct.frst_nm, subs.pri m_rsrc_valu_txt as prim_rsrc_valu_txt , ord_ tran.serv_type_cd as serv_type_cd, ord_tra n.ord_actn_done_ts as ord_actn_done_ts , ord_t ran.ord_actn_done_date_key, ord_tran.ord_tran_ye ar_mnth_no, subs.subs_id as subs_ id , oa_stts.ord_actn_stts_ds as ord_actn_stt s_ds , assg_prod_stat.assg_prod_stat_id, oa_type.ord_actn_type_ds as ord_actn_type_ds , oa_rsn.ord_actn_rsn_ds as ord_actn_rsn_ds , ord_tran.assg_prod_id as assg_prod_id , ord_tran.main_cmpn_id, ord_tran.assg_p rce_plan_id as assg_prce_plan_id, prod_offr.pro d_ds as main_prod_offr_ds, assg_bill_o ffr.bill_offr_id, -- added to populate config table assg_bill_offr.rc_amt, ap_clss.serv_tech_nm as main_prod_offr_clss_ds, ap_prev_clss.serv_tech _nm as prev_main_prod_offr_clss_ds --chnl_nm. sale_serv_chnl_nm from ep_rel.ord_tran, (select subs_key,accs_l kge_id,subs_id,bb_user_nm,prim_rsrc_valu_txt,open_ts,clse_ts,mai n_prod_offr_clss_ds,prev_main_prod_offr_clss_ds,main_prod_offr_d s,prev_main_prod_offr_ds,main_bill_offr_rc_amt from ep_rel.subs where ecf_delt_flg = 0 ) subs, (select ord_actn_stts_key,ord_ actn_stts_ds,open_ts,clse_ts from ep_rel.ord_actn_stts where e cf_delt_flg = 0 ) oa_stts, (select ord_actn_type_key,ord_actn_ type_ds,ord_actn_type_id,open_ts,clse_ts from ep_rel.ord_actn_ty pe where ecf_delt_flg = 0 ) oa_type, (select ord_actn_rsn_ke y,ord_actn_rsn_ds,ord_actn_rsn_id,open_ts,clse_ts from ep_rel.or d_actn_rsn where ecf_delt_flg = 0 ) oa_rsn, (select ctct_key ,idnt_doc_1_no,open_ts,clse_ts,frst_nm from ep_rel.ctct where e cf_delt_flg = 0 ) ctct, (select cust_key,cust_id,open_ts,clse_t s from ep_rel.cust where ecf_delt_flg = 0 ) cust, (select base _plan_ind,open_ts,clse_ts,bill_offr_key,bill_offr_ds,bill_offr_i d,rc_amt from ep_rel.bill_offr where ecf_delt_flg = 0 ) assg_ bill_offr, (select prod_ctlg_item_id,prod_ctlg_key, prod_ds,open _ts,clse_ts from ep_rel.prod_ctlg where ecf_delt_flg = 0 ) ass g_cmpn_offr, (select empl_or_ssmn_cd,open_ts,clse_ts,empl_key fr om ep_rel.empl where ecf_delt_flg = 0) empl, (select assg_prod_ stat_id,open_ts,clse_ts,assg_prod_stat_key from ep_rel.assg_prod _stat where ecf_delt_flg = 0 ) assg_prod_stat, (select prod_ds , prod_ctlg_key from ep_rel.prod_ctlg where ecf_delt_flg=0 and ecf_xpir_ts='31-dec-9999') prod_offr, (select assg_prod_id,serv_ tech_nm from ( select assg_prod_id,serv_tech_nm, rank() over ( p artition by assg_prod_id order by strt_ts desc,end_ts desc,assg_ prod_vrsn_id desc) as rank from ep_rel.assg_prod ap where ap.ecf _xpir_ts='31-dec-9999' and ap.main_cmpn_flg=1 and ap.serv_tech_n m is not null ) where rank=1 ) ap_clss, (select assg_prod_id,ser v_tech_nm from ( select assg_prod_id,serv_tech_nm,rank() over ( partition by assg_prod_id order by strt_ts desc,end_ts desc,assg _prod_vrsn_id desc) as rank from ep_rel.assg_prod ap where ap.ec f_xpir_ts='31-dec-9999' and ap.main_cmpn_flg=1 and ap.serv_tech_ nm is not null ) where rank=2) ap_prev_clss --(select sale_serv_ chnl_key, sale_serv_chnl_nm, open_ts, clse_ts fr om ep_rel.sale_serv_chnl where ecf_delt_flg = 0 ) chnl_nm whe re ord_tran.subs_key = subs.subs_key (+) and ord_tra n.bill_offr_key = assg_bill_offr.bill_offr_key (+) and or d_tran.prod_ctlg_key = assg_cmpn_offr.prod_ctlg_key (+) a nd ord_tran.ord_actn_stts_key = oa_stts.ord_actn_stts_key (+) and ord_tran.ord_actn_type_key = oa_type.ord_actn_type_key (+) and ord_tran.ord_actn_rsn_key = oa_rsn.ord_actn_rsn_key (+) and ord_tran.main_ctct_key = ctct.ctct_key(+) and ord_ tran.cust_key = cust.cust_key(+) and ord_tran.assg_p rod_stat_key = assg_prod_stat.assg_prod_stat_key(+) and ord_tr an.crte_empl_key = empl.empl_key(+) and ord_tran.main_pro d_offr_key = prod_offr.prod_ctlg_key and ord_tran.main_cmpn_id = ap_clss.assg_prod_id (+) and ord_tran.main_cmpn_id = ap_prev_clss.assg_prod_id (+) and ord_tran.open_ts >= subs.open_ts (+) and ord_tran.open_ts < su bs.clse_ts (+) and ord_tran.open_ts >= oa_stts.open _ts (+) and ord_tran.open_ts < oa_stts.clse_ts (+) and ord_tran.open_ts >= oa_type.open_ts (+) and o rd_tran.open_ts < oa_type.clse_ts (+) and ord_tran. open_ts >= oa_rsn.open_ts (+) and ord_tran.open_ts < oa_rsn.clse_ts (+) and ord_tran.open_ts >= ctct.open_ts (+) and ord_tran.open_ts < ctct.c lse_ts (+) and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust.clse_ts (+) and ord_ tran.open_ts >= assg_bill_offr.open_ts (+) and ord_ tran.open_ts < assg_bill_offr.clse_ts (+) and ord_t ran.open_ts >= assg_cmpn_offr.open_ts (+) and ord_t ran.open_ts < assg_cmpn_offr.clse_ts (+) and ord_tr an.open_ts >= assg_prod_stat.open_ts (+) and ord_tr an.open_ts < assg_prod_stat.clse_ts (+) and ord_tra n.open_ts >= empl.open_ts (+) and ord_tran.open_ts < empl.clse_ts (+) /* and ord_tran.open_ts >= chnl_nm.open_ts (+) and ord_tran.open_ts < chn l_nm.clse_ts (+)*/ /*and ord_tran.ord_actn_strt_date_key betw een 20180201 and 20180227*/ and upper(ord_tran.main_cmpn_nm) i n ('broadband main') and upper(oa_type.ord_actn_type_ds) in ( 'change' ) and upper(ord_actn_rsn_ds) in ('recontracting','cha nge plan') and ord_tran.main_ctct_key <> -1 and upper(ctct.f rst_nm) not like 'brt%' and ord_tran.ecf_delt_flg = 0 and as sg_cmpn_offr.prod_ctlg_item_id = '8623942' and assg_prce_plan_ id <> -1 and assg_prc_plan_stts_key <> 3 --and ord_actn_strt _date_key between to_char(trunc(sysdate-7, 'iw'),'yyyymmdd') and to_char(next_day(trunc(sysdate-7,'iw'),'sunday'),'yyyymmdd') - -- for tv oed; -- and ord_tran.ord_actn_strt_date_key between 20180910 and 20180916;