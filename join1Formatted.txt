select a.* , count(1) as vol from ( select c.*, case when team in ('04-telesales - inbound','05-telesales - outbound') then '04-telesales' when team in ('06-event (outsource)','07-event (in-house)','08-d2d (outsource)','09d2d (in-house)','09-d2d (in-house)') then '05-direct sales' when team like ('10-dh-telesales') then '06-dh-telesales' when team in ('11-cust care','12-others') then'07-others' else team end as team_grp from (select to_date(ord_actn_strt_date_key,'yyyymmdd' ) as oed_date , substr(to_char(to_date(ord_actn_strt_date_key,'yyyymmdd'),'day'),1,3) as oed_day , week_strt_dt ,cast((case when trim(to_char(to_date(ord_actn_strt_date_key,'yyyymmdd'),'day')) in ('saturday','sunday') then 'y' else 'n' end)as varchar2(7)) as weekend , case when (main_prod_offr_dslike '%50m%' or main_prod_offr_ds like '50m%') then 'fibre 50m' when (main_prod_offr_ds like '%500m%' or main_prod _offr_ds like '500m%') then 'fibre 500m' when main_prod_offr_ds like '10g%' then 'fibre 10gbps' when(main_prod_offr_ds like '1g%' and upper(main_prod_offr_ds) like'%mesh%') then 'fibre 1gbps w wifi mesh' when main_prod_offr_ds like '1g%' then 'fibre 1gbps' whenmain_prod_offr_ds like '2g%' then 'fibre 2gbps' when main_prod_offr_ds like '1x1%' then 'fibre 1x1gbps' when main_prod_offr_ds like '300m%' then 'fibre 300m' when main_prod_offr_ds like 'mio home%' then 'mio home' when main_prod_offr_ds like 'singtel home broadban d' then 'standalone' else '' end asplan_grp_2 , main_prod_offr_ds as plan_grp , 'grossadd' as driver , cast('' as varchar2(8)) as port_ind, '01)r' as seg_grp , ord_actn_stts_ds , deal_id asdealer_code , empl_or_ssmn_cd as salesman_code , case when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then'' else d.vndr_nm end as vendor_name , casewhen b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then '' else d.dealer_nm end as dealer_name , cas e when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then e. vndr_cd when d.team in ('01-retail','02-channels','03-eshop','04-telesales - inbound','05-telesales - outbound','06-event (outsource)','07-event (in-house)','08-d2d (outsource)','09-d2d (in-house)','09-d2d (in-house)','10-dh-telesales','11-cust care') then d.shop_nm else '' end as shop_name , case when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then e.team when d.team in (' 01-retail','02-channels','03-eshop','04-telesales - inbound','05-telesales - outbound','06-event (outsource)','07-event (in-house)','08-d2d (outsource)','09-d2d (in-house)','09-d2d (in-house)' ,'10-dh-telesales','11-cust care') then d.team else '12-others' end as team from ( select a.*, h.week_strt_dtfrom (select distinct ord_tran.ord_actn_id as ord_actn_id , ord_tran.ord_id as order_id, ord_tran.deal_id, ord_tran.deal_nm, ord_tran.vndr_id, ord_tran.vndr_nm, subs.accs_lkge_id, ord_tran.cust_rqst_ts, subs.bb_user_nm, empl.empl_or_ssmn_cd, ord_tran.ord_actn_strt_ts as ord_actn_strt_ts , ord_tran.ord_actn_strt_date_key, ord_tran.main_cmpn_nm, assg_cmpn_offr.prod_ds cmpn_prod_ds, assg_bill_offr.bill_offr_ds bill_offr_ds, assg_bill_offr.base_plan_ind, cust.cust_id, ctct.idnt_doc_1_no as cust_ctct_idnt_doc_1_no ,ctct.frst_nm, subs.prim_rsrc_valu_txt as prim_rsrc_valu_txt , ord_tran.serv_type_cd as serv_type_cd, ord_tran.ord_actn_done_ts as ord_actn_done_ts , ord_tran.ord_actn_done_date_key, ord_tran.ord_tran_year_mnth_no,subs.subs_id as subs_id , oa_stts.ord_actn_stts_ds as ord_actn_stts_ds , assg_prod_stat.assg_prod_stat_id, oa_type.ord_actn_type_ds as ord_actn_type_ds , oa_rsn.ord_actn_rsn_ds as ord_actn_rsn_ds , ord_tran.assg_prod_id as assg_prod_id , ord_tran.main_cmpn_id, ord_tran.assg_prce_plan_id asassg_prce_plan_id, prod_offr.prod_ds as main_prod_offr_ds, assg_bill_offr.bill_offr_id -- addedto populate config table from ep_rel.ord_tran, (select subs_key,bb_user_nm,accs_lkge_id,subs_id,prim_rsrc_valu_txt,open_ts,clse_ts,main_prod_offr_ds from ep_rel.subs where ecf_delt_flg = 0 ) subs, (select ord_actn_stts_key,ord_actn_stts_ds,open_ts,clse_ts from ep_rel.ord_actn_stts where ecf_delt_flg = 0 ) oa_stts, (selectord_actn_type_key,ord_actn_type_ds,ord_actn_type_id,open_ts,clse_ts from ep_rel.ord_actn_type whereecf_delt_flg = 0 ) oa_type, (select ord_actn_rsn_key,ord_actn_rsn_ds,ord_actn_rsn_id,open_ts,clse_ts from ep_rel.ord_actn_rsn where ecf_delt_flg = 0 ) oa_rsn, (select ctct_key,idnt_doc_1_no,open_ts,clse_ts,frst_nmfrom ep_rel.ctct where ecf_delt_flg = 0 ) ctct, (select cust_key,cust_id,open_ts,clse_ts from ep_rel.cust where ecf_delt_flg = 0 ) cust, (select base_plan_ind,open_ts,clse_ts,bill_offr_key,bill_offr_ds,bill_offr_id from ep_rel.bill_offr where ecf_delt_flg = 0 ) assg_bill_offr, (select prod_ctlg_item_id,prod_ctlg_key, prod_ds,open_ts,clse_ts from ep_rel.prod_ctlg where ecf_d elt_flg = 0 ) assg_cmpn_offr, (select empl_or_ssmn_cd,open_ts,clse_ts,empl_key from ep_rel.empl where ecf_delt_flg = 0) empl, (select assg_prod_stat_id,open_ts,clse_ts,assg_prod_stat_keyfrom ep_rel.assg_prod_stat w here ecf_delt_flg = 0 ) assg_prod_stat, (select prod_ds , prod_ctlg_key from ep_rel.prod_ctlg where ecf_delt_flg=0 and ecf_xpir_ts='31-dec-9999') prod_offr where ord_tran.subs_key = subs.subs_key (+) and ord_tran.bill_offr_key = assg_bill_offr.bill_offr_key (+) and ord_tran.prod_ctlg_key = assg_cmpn_offr.prod_ctlg_key (+) and ord_tran.ord_actn_stts_key = oa_stts.ord_actn_stts_key (+) and ord_tran. ord_actn_type_key = oa_type.ord_actn_type_key (+) and ord_tran.ord_actn_rsn_key = oa_rsn.ord_actn_rsn_key (+) and ord_tran.main_ctct_key = ctct.ctct_key(+) and ord_tran.cust_key= cust.cust_key(+) and ord_tran.assg_prod_stat_key =assg_prod_stat.assg_prod_stat_key(+) and ord_tran.crte_empl_key = empl.empl_key(+) and ord_tran.main_prod_offr_key =prod_offr.prod_ctlg_key (+) and ord_tran.open_ts >= subs.open_ts (+) and ord_tran.open_ts < subs.clse_ts(+) and ord_tran.open_ts >= oa_stts.open_ts (+)and ord_tran.open_ts < oa_stts.clse_ts (+) and ord_tran.open_ts >= oa_type.open_ts (+) and ord_tran.open_ts < oa_type.clse_ts (+) and ord_tran.open_ts>= oa_rsn.open_ts (+) and ord_tran.open_ts < oa_rsn.clse_ts (+) and ord_tran.open_ts >= ctct. open_ts (+) and ord_tran.open_ts < ctct.clse_ts (+)and ord_tran.open_ts >= cust.open_ts (+) and ord_tran.open_ts < cust.clse_ts (+) and ord_tran.open_ts >= assg_bill_offr.open_ts (+) and ord_tran.open_ts < assg_bill_offr.clse_ts (+) and ord_tran.open_ts >= assg_cmpn_offr.open_ts (+) and ord_tran.open_ts < assg_cmpn_offr.clse_ts (+) and ord_tran.open_ts>= assg_prod_stat.open_ts (+) and ord_tran.open_ts < assg_prod_stat.clse_ts (+) and ord_tran.open_ts >= empl.open_ts (+) and ord_tran.open_ts < empl.clse_ts (+) and upper(ord_tran.main_cmpn_nm) in ('broadband main') and upper(oa_type.ord_actn_type_ds) in ( 'provide' ) and ord_tran.main_ctct_key <> -1 and upper(ctct.frst_nm)not like 'brt%' and ord_tran.ecf_delt_flg = 0 and assg_cmpn_offr.prod_ctlg_item_id = '8623942' and assg_prce_plan_id <> 1 ) a left join biz_ba.cfg_week_edw h on a.ord_actn_strt_date_key = h.tm_perd_id where ord_actn_stts_ds in (' negotiation', 'delivery', 'done', 'completion') -- removed 'negotiation' on 19-mar-18 after aligning with xy and cmpn_prod_ds = 'broadband plan' and bill_offr_ds is not null and base_plan_ind = 'y' and cust_ctct_idnt_doc_1_no is not null and cust_id is not null and assg_prod_stat_id is not null and ord_actn_strt_date_key between to_number(to_char(trunc(sysdate-15),' yyyymmdd')) and to_number(to_char((sysdate-1),'yyyymmdd'))) b left join biz_ba.cfg_dealer_channel d on b.deal_id =d.dealer_cd left join ( select dealer_cd, bcc_login, shop_dealer_code, team, roadshow, dealer_cd || bcc_login as unique_key, vndr_cd, road_show_strt, road_show_end from biz_ba.cfg_roadshow_dealer_channel ) e on b.deal_id = e.dealer_cd and upper(b.empl_or_ssmn_cd) = upper(e.bcc_login) and b.ord_actn_strt_date_key between e.road_show_strt and e.road_show_end union all selectto_date(ord_actn_strt_date_key,'yyyymmdd') as oed_date, substr(to_char(to_date(ord_actn_strt_date_key,'yyyymmdd'),'day'),1,3) as oed_day , week_strt_dt , cast((case when trim(to_char(to_date(ord_actn_strt_date_key,'yyyymmdd'),'day')) in('saturday','sunday') then 'y' else 'n' end) as varchar2(7)) as weekend , case when (main_prod_offr_ds like '%50m%' or main_prod_offr_ds like '50m%') then 'fibre 50m' when(main_prod_offr_ds like '%500m%' or main_prod_offr_ds like '500m%') then 'fibre 500m' when main_prod_offr_ds like'10g%' then 'fibre 10gbps' when (main_prod_offr_dslike '1g%' and upper(main_prod_offr_ds) like '%mesh%') then 'fibre 1gbps w wifi mesh' when main_prod_offr_ds like'1g%' then 'fibre 1gbps' when main_prod_offr_ds like '2g%' then 'fibre 2gbps' when main_prod_offr_ds like '1x1%' then 'fibre 1x1gbps' when main_prod_offr_ds like '300m%' then 'fibre 300m' when main_prod_offr_ds like 'mio home%' then 'mio home' whenmain_prod_offr_ds like 'singtel home broadband' then 'standalone' else '' end as plan_grp_2 ,main_prod_offr_ds as plan_grp , case when ordrtype_ind like '1. adsl to fibre' then 'migr' when upper(ord_actn_rsn_ds) in ('recontracting') then 'recon' else'change offer' end driver , cast('' as varchar2(8)) as port_ind , '01)r' as seg_grp , ord_actn_stts_ds ,deal_id as dealer_code , empl_or_ssmn_cd as salesman_code , case when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then '' else d.vndr_nm end as vendor_name, case when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then '' else d.dealer_nm end as dealer_name, case when b.deal_id in ('d3006', 'd3007', 'd3008', 'd3009') then e.vndr_cd when d.team in ('01-retail','02-channels','03-eshop','04-telesales - inbound','05-telesales - outbound','06-event (outsource)','07-event (in-house)','08d2d (outsource)','09-d2d (in-house)','09-d2d (in-house)','10-dhtelesales','11-cust care') then d.shop_nm else '' end as shop_name , case when b.deal_id in ('d3006','d3007', 'd3008', 'd3009') then e.team when d.team in ('01-retail','02-channels','03-eshop','04-telesales - inbound','05-telesales - outboun);